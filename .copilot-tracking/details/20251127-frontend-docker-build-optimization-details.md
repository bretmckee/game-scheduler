<!-- markdownlint-disable-file -->
# Task Details: Frontend Docker Build Optimization

## Research Reference

**Source Research**: #file:../research/20251127-frontend-docker-build-optimization-research.md

## Phase 1: Create .dockerignore Safety Net

### Task 1.1: Create comprehensive .dockerignore in project root

Create `.dockerignore` file as backup protection to prevent unnecessary files from entering build context even if accidentally referenced.

- **Files**:
  - `.dockerignore` - New file in project root
- **Success**:
  - File created with comprehensive patterns covering node_modules, build outputs, IDE files, test files, logs
  - Patterns use `**/` prefix for recursive matching across all directories
  - Includes safety patterns for common files that should never be in build context
- **Research References**:
  - #file:../research/20251127-frontend-docker-build-optimization-research.md (Lines 105-165) - Complete .dockerignore template with explanatory comments
  - #file:../../.github/instructions/containerization-docker-best-practices.instructions.md - Docker best practices emphasizing .dockerignore usage
- **Dependencies**:
  - None

**Content Pattern**: Use broad recursive patterns with `**/` prefix to catch files in any directory. Include patterns for:
- Node modules and package manager files (`**/node_modules/`, `**/.pnp/`)
- Build outputs (`**/dist/`, `**/build/`, `**/coverage/`)
- Environment files (`**/.env*` with exception for `.env.example`)
- IDE files (`**/.vscode/`, `**/.idea/`, `**/.cursor/`)
- Test files (`**/test/`, `**/*.test.*`, `**/*.spec.*`)
- Logs and temporary files (`**/*.log*`, `**/.tmp/`, `**/*.cache`)
- Git files (`**/.git/`, `**/.gitignore`)
- Documentation (`**/*.md` with exception for `README.md`)

## Phase 2: Implement Selective COPY Instructions

### Task 2.1: Replace broad COPY with explicit selective COPY statements

Replace the single broad `COPY frontend/ ./` instruction with multiple explicit COPY statements that only include necessary files for the build.

- **Files**:
  - `docker/frontend.Dockerfile` - Modify line 11 to replace broad COPY
- **Success**:
  - Broad `COPY frontend/ ./` replaced with selective COPY statements
  - Source code directory copied: `COPY frontend/src ./src`
  - Build configuration files copied individually: index.html, vite.config.ts, tsconfig.json, tsconfig.node.json, vitest.config.ts
  - package.json already copied earlier (existing line 7)
  - node_modules generated by npm ci (existing line 8)
  - Build still completes successfully
- **Research References**:
  - #file:../research/20251127-frontend-docker-build-optimization-research.md (Lines 167-196) - Detailed implementation showing exact COPY replacement pattern
  - #file:../research/20251127-frontend-docker-build-optimization-research.md (Lines 198-216) - Explanation of why selective COPY provides complete control
- **Dependencies**:
  - Task 1.1 completion (for safety net)

**Implementation Pattern**:
```dockerfile
# Replace:
COPY frontend/ ./

# With:
COPY frontend/src ./src
COPY frontend/index.html ./
COPY frontend/vite.config.ts ./
COPY frontend/tsconfig.json ./
COPY frontend/tsconfig.node.json ./
COPY frontend/vitest.config.ts ./
```

## Phase 3: Validation and Testing

### Task 3.1: Test Docker build with optimizations

Run full Docker build to verify all necessary files are present and build completes successfully.

- **Files**:
  - `docker/frontend.Dockerfile` - Test build
- **Success**:
  - Docker build completes without errors
  - Build finds all necessary source files
  - Build finds all configuration files
  - Production image created successfully
  - Frontend application works correctly
- **Research References**:
  - #file:../research/20251127-frontend-docker-build-optimization-research.md (Lines 218-229) - Expected build behavior and cache efficiency
  - #file:../research/20251127-frontend-docker-build-optimization-research.md (Lines 260-272) - Success criteria
- **Dependencies**:
  - Phase 1 and Phase 2 completion

**Test Command**: `docker compose build frontend` or `docker build -f docker/frontend.Dockerfile -t frontend-test .`

### Task 3.2: Verify build context size reduction

Measure and confirm that build context size has been reduced from ~413MB to <300KB.

- **Files**:
  - Docker build output analysis
- **Success**:
  - Build context size reported as <300KB (ideally ~270KB)
  - Confirmation that node_modules (413MB) not included in context
  - Only explicitly copied files present in build context
- **Research References**:
  - #file:../research/20251127-frontend-docker-build-optimization-research.md (Lines 231-246) - Before/after comparison showing expected 413MB to 270KB reduction
- **Dependencies**:
  - Task 3.1 completion

**Verification Method**: Check Docker build output for "sending build context" message, or use `docker build --progress=plain` to see detailed context size.

### Task 3.3: Validate incremental build performance

Test that source code changes trigger fast incremental builds without invalidating dependency layer cache.

- **Files**:
  - Any file in `frontend/src/`
- **Success**:
  - Make trivial change to source file (e.g., add comment to `frontend/src/App.tsx`)
  - Rebuild frontend image
  - Dependency installation layer uses cache (npm ci not re-run)
  - Only source copy and build layers re-execute
  - Incremental build completes in <10 seconds
- **Research References**:
  - #file:../research/20251127-frontend-docker-build-optimization-research.md (Lines 218-229) - Cache efficiency explanation showing dependencies layer preserved
  - #file:../research/20251127-frontend-docker-build-optimization-research.md (Lines 231-246) - Expected 60-90% faster incremental builds
- **Dependencies**:
  - Task 3.2 completion

**Test Procedure**:
1. Complete initial build (establishes cache)
2. Modify `frontend/src/App.tsx` (add comment or whitespace)
3. Rebuild: `docker compose build frontend`
4. Verify output shows "CACHED" for npm ci layer
5. Measure total rebuild time (should be <10 seconds)

## Dependencies

- Docker

## Success Criteria

- Build context size reduced to <300KB
- Incremental builds complete in <10 seconds  
- Dependencies layer cache preserved across source changes
- Production image builds successfully
- Only explicitly listed files enter build context
- .dockerignore provides backup protection
